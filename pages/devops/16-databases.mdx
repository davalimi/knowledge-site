# Databases - Les bases pour le DevOps

`[DEBUTANT]` - Temps: 45 min lecture + 30 min pratique

---

## Why - Pourquoi c'est important

Les bases de donnees sont au coeur de toutes les applications. En tant que DevOps, tu dois:
- Deployer et configurer des BDD
- Gerer les backups et la restauration
- Monitorer les performances
- Gerer les migrations

Tu n'es pas DBA, mais tu dois comprendre les bases.

---

## What - C'est quoi

### Types de bases de donnees

```
┌─────────────────────────────────────────────────────────────┐
│                    TYPES DE BDD                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  RELATIONNELLES (SQL)                                        │
│  ────────────────────                                        │
│  - Tables, lignes, colonnes                                 │
│  - Relations entre tables                                   │
│  - ACID (Atomicity, Consistency, Isolation, Durability)     │
│  - Ex: PostgreSQL, MySQL, MariaDB                           │
│                                                              │
│  DOCUMENT (NoSQL)                                            │
│  ────────────────                                            │
│  - Documents JSON                                           │
│  - Schema flexible                                          │
│  - Ex: MongoDB, CouchDB                                     │
│                                                              │
│  KEY-VALUE                                                   │
│  ─────────                                                   │
│  - Cle → Valeur                                             │
│  - Ultra rapide                                             │
│  - Ex: Redis, Memcached                                     │
│                                                              │
│  COLONNES                                                    │
│  ────────                                                    │
│  - Optimise pour analytics                                  │
│  - Big data                                                 │
│  - Ex: Cassandra, ClickHouse                                │
│                                                              │
│  GRAPHE                                                      │
│  ──────                                                      │
│  - Relations complexes                                      │
│  - Ex: Neo4j                                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Quand utiliser quoi

| Use Case | Type | Exemple |
|----------|------|---------|
| App web classique | SQL | PostgreSQL |
| Cache/Sessions | Key-Value | Redis |
| Logs, documents | Document | MongoDB |
| Analytics | Colonnes | ClickHouse |
| Social network | Graphe | Neo4j |

---

## How - En pratique

### PostgreSQL

#### Installation Docker

```bash
docker run -d \
  --name postgres \
  -e POSTGRES_USER=myuser \
  -e POSTGRES_PASSWORD=mypassword \
  -e POSTGRES_DB=mydb \
  -p 5432:5432 \
  -v pgdata:/var/lib/postgresql/data \
  postgres:15
```

#### Connexion

```bash
# CLI
docker exec -it postgres psql -U myuser -d mydb

# Ou depuis l'exterieur
psql -h localhost -U myuser -d mydb
```

#### Commandes SQL de base

```sql
-- Lister les bases
\l

-- Se connecter a une base
\c mydb

-- Lister les tables
\dt

-- Decrire une table
\d users

-- Creer une table
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Inserer
INSERT INTO users (name, email) VALUES ('John', 'john@example.com');

-- Selectionner
SELECT * FROM users;
SELECT name, email FROM users WHERE created_at > '2024-01-01';

-- Mettre a jour
UPDATE users SET name = 'Jane' WHERE id = 1;

-- Supprimer
DELETE FROM users WHERE id = 1;

-- Quitter
\q
```

#### Configuration importante

```ini
# postgresql.conf
max_connections = 100
shared_buffers = 256MB        # 25% de la RAM
work_mem = 4MB
maintenance_work_mem = 64MB
effective_cache_size = 768MB  # 75% de la RAM

# Logging
log_destination = 'stderr'
logging_collector = on
log_min_duration_statement = 1000  # Log queries > 1s
```

#### Backup et restauration

```bash
# Backup
pg_dump -U myuser -h localhost mydb > backup.sql
pg_dump -U myuser -h localhost -Fc mydb > backup.dump  # Format custom

# Backup toutes les bases
pg_dumpall -U postgres > all_databases.sql

# Restauration
psql -U myuser -d mydb < backup.sql
pg_restore -U myuser -d mydb backup.dump

# Backup automatise (cron)
0 2 * * * pg_dump -U myuser mydb | gzip > /backups/mydb_$(date +\%Y\%m\%d).sql.gz
```

### MySQL/MariaDB

#### Installation Docker

```bash
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=rootpassword \
  -e MYSQL_DATABASE=mydb \
  -e MYSQL_USER=myuser \
  -e MYSQL_PASSWORD=mypassword \
  -p 3306:3306 \
  -v mysqldata:/var/lib/mysql \
  mysql:8
```

#### Commandes

```bash
# Connexion
docker exec -it mysql mysql -u myuser -p mydb

# Ou
mysql -h localhost -u myuser -p mydb
```

```sql
-- Lister les bases
SHOW DATABASES;

-- Utiliser une base
USE mydb;

-- Lister les tables
SHOW TABLES;

-- Creer une table
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Voir les processus
SHOW PROCESSLIST;

-- Quitter
EXIT;
```

#### Backup

```bash
# Backup
mysqldump -u myuser -p mydb > backup.sql
mysqldump -u myuser -p --all-databases > all_backup.sql

# Restauration
mysql -u myuser -p mydb < backup.sql
```

### Redis

#### Installation Docker

```bash
docker run -d \
  --name redis \
  -p 6379:6379 \
  -v redisdata:/data \
  redis:7 redis-server --appendonly yes
```

#### Commandes

```bash
# CLI
docker exec -it redis redis-cli

# Ou
redis-cli -h localhost -p 6379
```

```redis
# Strings
SET mykey "Hello"
GET mykey
SET counter 1
INCR counter
EXPIRE mykey 60  # TTL 60 secondes
TTL mykey

# Lists
LPUSH mylist "a"
RPUSH mylist "b"
LRANGE mylist 0 -1

# Hashes
HSET user:1 name "John"
HSET user:1 email "john@example.com"
HGETALL user:1

# Sets
SADD myset "a" "b" "c"
SMEMBERS myset

# Info
INFO
DBSIZE
FLUSHDB  # Vider la base

# Quitter
QUIT
```

### MongoDB

#### Installation Docker

```bash
docker run -d \
  --name mongodb \
  -e MONGO_INITDB_ROOT_USERNAME=root \
  -e MONGO_INITDB_ROOT_PASSWORD=password \
  -p 27017:27017 \
  -v mongodata:/data/db \
  mongo:7
```

#### Commandes

```bash
# CLI
docker exec -it mongodb mongosh -u root -p password
```

```javascript
// Utiliser une base
use mydb

// Collections
show collections

// Inserer
db.users.insertOne({ name: "John", email: "john@example.com" })
db.users.insertMany([
  { name: "Jane", email: "jane@example.com" },
  { name: "Bob", email: "bob@example.com" }
])

// Trouver
db.users.find()
db.users.find({ name: "John" })
db.users.findOne({ email: "john@example.com" })

// Mettre a jour
db.users.updateOne(
  { name: "John" },
  { $set: { email: "john.new@example.com" } }
)

// Supprimer
db.users.deleteOne({ name: "John" })

// Quitter
exit
```

### Haute disponibilite

```
┌─────────────────────────────────────────────────────────────┐
│                    HAUTE DISPONIBILITE                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  REPLICATION                                                 │
│  ───────────                                                 │
│  - Master/Primary: ecritures                                │
│  - Replica/Secondary: lectures                              │
│  - Failover si master down                                  │
│                                                              │
│  ┌─────────┐      ┌─────────┐      ┌─────────┐             │
│  │ Primary │ ───▶ │ Replica │      │ Replica │             │
│  │  (R/W)  │      │  (Read) │      │  (Read) │             │
│  └─────────┘      └─────────┘      └─────────┘             │
│                                                              │
│  CLUSTERING                                                  │
│  ──────────                                                  │
│  - Plusieurs nodes actifs                                   │
│  - Sharding (repartition des donnees)                       │
│  - Ex: PostgreSQL (Patroni), MySQL (Galera)                │
│                                                              │
│  MANAGED SERVICES                                            │
│  ────────────────                                            │
│  - AWS RDS, Aurora                                          │
│  - Azure SQL, Cosmos DB                                     │
│  - GCP Cloud SQL                                            │
│  - Gestion HA par le provider                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Migrations de schema

```bash
# Outils populaires
# - Flyway (Java, SQL)
# - Alembic (Python)
# - Knex (Node.js)
# - golang-migrate (Go)
```

```sql
-- Exemple: migrations/V1__create_users.sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);

-- migrations/V2__add_email.sql
ALTER TABLE users ADD COLUMN email VARCHAR(255);

-- migrations/V3__add_index.sql
CREATE INDEX idx_users_email ON users(email);
```

```bash
# Avec Flyway
flyway -url=jdbc:postgresql://localhost/mydb -user=myuser migrate

# Avec Alembic (Python)
alembic revision --autogenerate -m "Add email column"
alembic upgrade head
```

### Monitoring

```yaml
# Prometheus exporter pour PostgreSQL
docker run -d \
  --name postgres-exporter \
  -e DATA_SOURCE_NAME="postgresql://user:pass@postgres:5432/mydb?sslmode=disable" \
  -p 9187:9187 \
  prometheuscommunity/postgres-exporter
```

```promql
# Queries PromQL
pg_up                              # Database up
pg_database_size_bytes             # Taille de la base
pg_stat_activity_count             # Connexions actives
pg_stat_user_tables_seq_scan       # Full table scans
pg_replication_lag                 # Lag de replication
```

---

## Practice - Exercices

### Exercice 1: Setup PostgreSQL

```bash
# 1. Lancer PostgreSQL
docker run -d \
  --name pg-demo \
  -e POSTGRES_PASSWORD=secret \
  -p 5432:5432 \
  postgres:15

# 2. Creer une base et une table
docker exec -it pg-demo psql -U postgres << 'EOF'
CREATE DATABASE demo;
\c demo
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100),
  price DECIMAL(10,2)
);
INSERT INTO products (name, price) VALUES
  ('Widget', 19.99),
  ('Gadget', 29.99);
SELECT * FROM products;
EOF

# 3. Backup
docker exec pg-demo pg_dump -U postgres demo > backup.sql

# 4. Nettoyer
docker rm -f pg-demo
```

### Exercice 2: Redis cache

```bash
# 1. Lancer Redis
docker run -d --name redis-demo -p 6379:6379 redis:7

# 2. Stocker des donnees
docker exec -it redis-demo redis-cli << 'EOF'
SET user:1:name "John"
SET user:1:email "john@example.com"
EXPIRE user:1:name 3600
GET user:1:name
TTL user:1:name
KEYS user:*
EOF

# 3. Nettoyer
docker rm -f redis-demo
```

### Exercice 3: Replication PostgreSQL

```yaml
# docker-compose.yml
version: '3'
services:
  primary:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_USER: repl
    command: |
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
    ports:
      - "5432:5432"

  replica:
    image: postgres:15
    environment:
      PGDATA: /var/lib/postgresql/data
    depends_on:
      - primary
    # Note: config replication complete est plus complexe
```

---

## Cheatsheet

```
┌─────────────────────────────────────────────────────────────┐
│                       DATABASES                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  POSTGRESQL                                                  │
│  ──────────                                                  │
│  psql -h host -U user -d db      # Connect                  │
│  \l                              # List databases           │
│  \dt                             # List tables              │
│  \d table                        # Describe table           │
│  pg_dump db > backup.sql         # Backup                   │
│  psql db < backup.sql            # Restore                  │
│                                                              │
│  MYSQL                                                       │
│  ─────                                                       │
│  mysql -h host -u user -p db     # Connect                  │
│  SHOW DATABASES;                 # List databases           │
│  SHOW TABLES;                    # List tables              │
│  DESCRIBE table;                 # Describe table           │
│  mysqldump db > backup.sql       # Backup                   │
│  mysql db < backup.sql           # Restore                  │
│                                                              │
│  REDIS                                                       │
│  ─────                                                       │
│  redis-cli                       # Connect                  │
│  SET key value                   # Set                      │
│  GET key                         # Get                      │
│  EXPIRE key 60                   # TTL                      │
│  KEYS pattern                    # Find keys                │
│                                                              │
│  MONGODB                                                     │
│  ───────                                                     │
│  mongosh                         # Connect                  │
│  use db                          # Select DB                │
│  db.collection.find()            # Query                    │
│  db.collection.insertOne({})     # Insert                   │
│                                                              │
│  BACKUP BEST PRACTICES                                       │
│  ─────────────────────                                       │
│  - Automatiser (cron)                                       │
│  - Tester les restaurations                                 │
│  - Stocker off-site (S3)                                    │
│  - Retention policy                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Interview Qs - Questions classiques

1. **Difference entre SQL et NoSQL?**
   → SQL: schema fixe, relations, ACID. NoSQL: schema flexible, scalabilite horizontale, eventual consistency.

2. **C'est quoi ACID?**
   → Atomicity (tout ou rien), Consistency (regles respectees), Isolation (transactions independantes), Durability (persiste apres commit).

3. **Quand utiliser Redis?**
   → Cache, sessions, rate limiting, pub/sub, queues. Pas pour stockage principal (RAM).

4. **Comment gerer les backups?**
   → Automatisation (cron/script), stockage externe (S3), retention, tests de restauration reguliers.

5. **C'est quoi la replication?**
   → Copier les donnees sur plusieurs serveurs. Haute dispo, read scaling, disaster recovery.

6. **Difference entre replication et sharding?**
   → Replication: meme donnees partout. Sharding: donnees reparties sur plusieurs nodes.

---

## Sujets lies

- **Lie:** [Docker](/devops/docker) - Containers pour BDD
- **Lie:** [AWS](/devops/aws) - RDS, Aurora, DynamoDB
- **Lie:** [Prometheus](/devops/prometheus) - Monitoring BDD

---

*Temps estime: 45 min lecture + 30 min pratique*
