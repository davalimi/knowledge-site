# AWS Services - Le cloud Amazon

`[DEBUTANT]` - Temps: 55 min lecture + 35 min pratique

---

## Why - Pourquoi c'est important

AWS est le leader du cloud (~32% du marche). La plupart des entreprises utilisent AWS. En tant que DevOps, tu dois connaitre les services principaux.

AWS a 200+ services. On va se concentrer sur les plus importants pour le DevOps.

---

## What - C'est quoi

### Les services essentiels

```
┌─────────────────────────────────────────────────────────────┐
│                    AWS SERVICES CLES                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  COMPUTE                                                     │
│  ───────                                                     │
│  EC2       Machines virtuelles                              │
│  Lambda    Serverless (fonctions)                           │
│  ECS/EKS   Containers (Docker/Kubernetes)                   │
│                                                              │
│  STORAGE                                                     │
│  ───────                                                     │
│  S3        Stockage objet (fichiers)                        │
│  EBS       Disques pour EC2                                 │
│  EFS       Systeme de fichiers partage                      │
│                                                              │
│  DATABASE                                                    │
│  ────────                                                    │
│  RDS       Bases relationnelles (MySQL, Postgres)           │
│  DynamoDB  NoSQL                                            │
│  ElastiCache  Cache (Redis, Memcached)                     │
│                                                              │
│  NETWORKING                                                  │
│  ──────────                                                  │
│  VPC       Reseau prive virtuel                             │
│  Route 53  DNS                                              │
│  ELB/ALB   Load balancing                                   │
│  CloudFront CDN                                             │
│                                                              │
│  SECURITY                                                    │
│  ────────                                                    │
│  IAM       Identites et acces                               │
│  Security Groups  Firewalls                                 │
│  KMS       Chiffrement                                      │
│                                                              │
│  DEVOPS                                                      │
│  ──────                                                      │
│  CodePipeline  CI/CD                                        │
│  ECR       Registry Docker                                  │
│  CloudWatch  Monitoring                                     │
│  CloudFormation  Infrastructure as Code                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Regions et AZs

```
┌─────────────────────────────────────────────────────────────┐
│                    GEOGRAPHIE AWS                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  REGIONS (25+ dans le monde)                                 │
│  ───────────────────────────                                 │
│  us-east-1       N. Virginia (la plus ancienne)             │
│  us-west-2       Oregon                                     │
│  eu-west-1       Ireland                                    │
│  eu-central-1    Frankfurt                                  │
│  ap-northeast-1  Tokyo                                      │
│                                                              │
│  AVAILABILITY ZONES (AZ)                                     │
│  ───────────────────────                                     │
│  - 3-6 AZs par region                                       │
│  - Datacenters physiquement separes                         │
│  - Nommes: eu-west-1a, eu-west-1b, eu-west-1c              │
│                                                              │
│  Bonnes pratiques:                                          │
│  - Deployer sur plusieurs AZs pour la haute dispo          │
│  - Choisir une region proche de tes users                  │
│  - Considerer le prix (varie selon region)                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## How - En pratique

### AWS CLI Setup

```bash
# Installer AWS CLI
# macOS
brew install awscli

# Linux
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Verifier
aws --version

# Configurer
aws configure
# AWS Access Key ID: AKIA...
# AWS Secret Access Key: ...
# Default region: eu-west-1
# Default output format: json

# Verifier la config
aws sts get-caller-identity
```

### EC2 - Machines virtuelles

```bash
# === LANCER UNE INSTANCE ===

# Trouver l'AMI (Amazon Machine Image)
aws ec2 describe-images \
  --owners amazon \
  --filters "Name=name,Values=amzn2-ami-hvm-*-x86_64-gp2" \
  --query 'Images | sort_by(@, &CreationDate) | [-1].ImageId' \
  --output text

# Creer une key pair
aws ec2 create-key-pair \
  --key-name my-key \
  --query 'KeyMaterial' \
  --output text > my-key.pem
chmod 400 my-key.pem

# Creer un security group
aws ec2 create-security-group \
  --group-name my-sg \
  --description "My security group"

# Autoriser SSH
aws ec2 authorize-security-group-ingress \
  --group-name my-sg \
  --protocol tcp \
  --port 22 \
  --cidr 0.0.0.0/0

# Lancer l'instance
aws ec2 run-instances \
  --image-id ami-xxxxx \
  --instance-type t2.micro \
  --key-name my-key \
  --security-groups my-sg \
  --count 1 \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=my-server}]'

# Lister les instances
aws ec2 describe-instances \
  --query 'Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress]' \
  --output table

# Se connecter
ssh -i my-key.pem ec2-user@PUBLIC_IP

# Arreter/Demarrer/Terminer
aws ec2 stop-instances --instance-ids i-xxxxx
aws ec2 start-instances --instance-ids i-xxxxx
aws ec2 terminate-instances --instance-ids i-xxxxx
```

### Types d'instances EC2

```
┌─────────────────────────────────────────────────────────────┐
│                    TYPES EC2                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  GENERAL PURPOSE (t, m)                                      │
│  ─────────────────────                                       │
│  t2.micro    1 vCPU, 1 GB   (Free tier)                     │
│  t3.medium   2 vCPU, 4 GB                                   │
│  m5.large    2 vCPU, 8 GB                                   │
│                                                              │
│  COMPUTE OPTIMIZED (c)                                       │
│  ─────────────────────                                       │
│  c5.large    2 vCPU, 4 GB   Pour calcul intensif            │
│                                                              │
│  MEMORY OPTIMIZED (r, x)                                     │
│  ───────────────────────                                     │
│  r5.large    2 vCPU, 16 GB  Pour bases de donnees           │
│                                                              │
│  STORAGE OPTIMIZED (i, d)                                    │
│  ────────────────────────                                    │
│  i3.large    2 vCPU, 15 GB  Pour IO intensif                │
│                                                              │
│  Pricing:                                                    │
│  - On-Demand: paye a l'heure                                │
│  - Reserved: 1-3 ans, -30-75%                               │
│  - Spot: jusqu'a -90%, peut etre interrompu                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### S3 - Stockage objet

```bash
# === BUCKETS ===

# Creer un bucket (nom unique globalement)
aws s3 mb s3://my-unique-bucket-name-12345

# Lister les buckets
aws s3 ls

# === FICHIERS ===

# Upload un fichier
aws s3 cp myfile.txt s3://my-bucket/
aws s3 cp myfile.txt s3://my-bucket/folder/

# Upload un dossier
aws s3 cp ./local-folder s3://my-bucket/folder/ --recursive

# Download
aws s3 cp s3://my-bucket/myfile.txt ./
aws s3 cp s3://my-bucket/folder/ ./local/ --recursive

# Sync (comme rsync)
aws s3 sync ./local s3://my-bucket/backup/
aws s3 sync s3://my-bucket/backup/ ./local

# Lister le contenu
aws s3 ls s3://my-bucket/
aws s3 ls s3://my-bucket/ --recursive

# Supprimer
aws s3 rm s3://my-bucket/myfile.txt
aws s3 rm s3://my-bucket/folder/ --recursive

# Supprimer le bucket (doit etre vide)
aws s3 rb s3://my-bucket
aws s3 rb s3://my-bucket --force  # Vide et supprime
```

### S3 Classes de stockage

```
┌─────────────────────────────────────────────────────────────┐
│                    S3 STORAGE CLASSES                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Standard                                                    │
│  ────────                                                    │
│  - Haute disponibilite                                      │
│  - Acces frequent                                           │
│  - Le plus cher                                             │
│                                                              │
│  Standard-IA (Infrequent Access)                            │
│  ─────────────────────────────                               │
│  - Moins cher au stockage                                   │
│  - Cout par acces                                           │
│  - Pour donnees peu accedees                                │
│                                                              │
│  Glacier                                                     │
│  ───────                                                     │
│  - Archive long terme                                       │
│  - Tres peu cher                                            │
│  - Retrieval en heures                                      │
│                                                              │
│  Glacier Deep Archive                                        │
│  ────────────────────                                        │
│  - Le moins cher                                            │
│  - Retrieval en 12h+                                        │
│  - Pour compliance, archives legales                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### VPC - Reseau

```bash
# === CREER UN VPC ===

# VPC
aws ec2 create-vpc --cidr-block 10.0.0.0/16 \
  --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=my-vpc}]'

# Subnet public
aws ec2 create-subnet \
  --vpc-id vpc-xxxxx \
  --cidr-block 10.0.1.0/24 \
  --availability-zone eu-west-1a \
  --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=public-1a}]'

# Subnet prive
aws ec2 create-subnet \
  --vpc-id vpc-xxxxx \
  --cidr-block 10.0.2.0/24 \
  --availability-zone eu-west-1a \
  --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=private-1a}]'

# Internet Gateway (pour acces Internet)
aws ec2 create-internet-gateway
aws ec2 attach-internet-gateway --vpc-id vpc-xxxxx --internet-gateway-id igw-xxxxx

# Route table
aws ec2 create-route-table --vpc-id vpc-xxxxx
aws ec2 create-route \
  --route-table-id rtb-xxxxx \
  --destination-cidr-block 0.0.0.0/0 \
  --gateway-id igw-xxxxx
```

### IAM - Identites et acces

```bash
# === USERS ===

# Creer un user
aws iam create-user --user-name devops-user

# Creer des access keys
aws iam create-access-key --user-name devops-user

# Attacher une policy
aws iam attach-user-policy \
  --user-name devops-user \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess

# === ROLES ===

# Creer un role pour EC2
aws iam create-role \
  --role-name EC2-S3-Role \
  --assume-role-policy-document file://trust-policy.json

# trust-policy.json:
# {
#   "Version": "2012-10-17",
#   "Statement": [{
#     "Effect": "Allow",
#     "Principal": {"Service": "ec2.amazonaws.com"},
#     "Action": "sts:AssumeRole"
#   }]
# }

# Attacher une policy au role
aws iam attach-role-policy \
  --role-name EC2-S3-Role \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess

# === POLICIES ===

# Creer une policy custom
aws iam create-policy \
  --policy-name S3-Backup-Policy \
  --policy-document file://policy.json

# policy.json:
# {
#   "Version": "2012-10-17",
#   "Statement": [{
#     "Effect": "Allow",
#     "Action": ["s3:GetObject", "s3:PutObject"],
#     "Resource": "arn:aws:s3:::my-bucket/*"
#   }]
# }
```

### RDS - Base de donnees

```bash
# Creer une instance PostgreSQL
aws rds create-db-instance \
  --db-instance-identifier mydb \
  --db-instance-class db.t3.micro \
  --engine postgres \
  --master-username admin \
  --master-user-password secretpassword \
  --allocated-storage 20 \
  --vpc-security-group-ids sg-xxxxx

# Lister les instances
aws rds describe-db-instances \
  --query 'DBInstances[*].[DBInstanceIdentifier,Endpoint.Address,DBInstanceStatus]' \
  --output table

# Creer un snapshot
aws rds create-db-snapshot \
  --db-instance-identifier mydb \
  --db-snapshot-identifier mydb-backup

# Supprimer
aws rds delete-db-instance \
  --db-instance-identifier mydb \
  --skip-final-snapshot
```

### ECR - Docker Registry

```bash
# Creer un repository
aws ecr create-repository --repository-name myapp

# Login Docker
aws ecr get-login-password | docker login \
  --username AWS \
  --password-stdin ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com

# Tag et push
docker tag myapp:latest ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/myapp:latest
docker push ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/myapp:latest

# Lister les images
aws ecr list-images --repository-name myapp
```

### ECS - Container Service

```bash
# ECS avec Fargate (serverless containers)

# Creer un cluster
aws ecs create-cluster --cluster-name my-cluster

# Task definition (JSON)
cat > task-def.json << 'EOF'
{
  "family": "my-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "256",
  "memory": "512",
  "executionRoleArn": "arn:aws:iam::ACCOUNT:role/ecsTaskExecutionRole",
  "containerDefinitions": [{
    "name": "myapp",
    "image": "ACCOUNT.dkr.ecr.REGION.amazonaws.com/myapp:latest",
    "portMappings": [{
      "containerPort": 80,
      "protocol": "tcp"
    }],
    "essential": true
  }]
}
EOF

# Enregistrer la task
aws ecs register-task-definition --cli-input-json file://task-def.json

# Creer un service
aws ecs create-service \
  --cluster my-cluster \
  --service-name my-service \
  --task-definition my-task \
  --desired-count 2 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[subnet-xxx],securityGroups=[sg-xxx],assignPublicIp=ENABLED}"
```

### CloudWatch - Monitoring

```bash
# Voir les metriques EC2
aws cloudwatch get-metric-statistics \
  --namespace AWS/EC2 \
  --metric-name CPUUtilization \
  --dimensions Name=InstanceId,Value=i-xxxxx \
  --start-time 2024-01-01T00:00:00Z \
  --end-time 2024-01-02T00:00:00Z \
  --period 3600 \
  --statistics Average

# Creer une alarme
aws cloudwatch put-metric-alarm \
  --alarm-name high-cpu \
  --metric-name CPUUtilization \
  --namespace AWS/EC2 \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --dimensions Name=InstanceId,Value=i-xxxxx

# Voir les logs
aws logs describe-log-groups
aws logs get-log-events \
  --log-group-name /aws/lambda/myfunction \
  --log-stream-name 'stream-name'
```

---

## Practice - Exercices

### Exercice 1: Premier EC2

```bash
# 1. Creer une key pair
aws ec2 create-key-pair --key-name demo-key \
  --query 'KeyMaterial' --output text > demo-key.pem
chmod 400 demo-key.pem

# 2. Creer un security group
SG_ID=$(aws ec2 create-security-group \
  --group-name demo-sg \
  --description "Demo SG" \
  --query 'GroupId' --output text)

aws ec2 authorize-security-group-ingress \
  --group-id $SG_ID --protocol tcp --port 22 --cidr 0.0.0.0/0

# 3. Lancer l'instance
INSTANCE_ID=$(aws ec2 run-instances \
  --image-id ami-0c55b159cbfafe1f0 \
  --instance-type t2.micro \
  --key-name demo-key \
  --security-group-ids $SG_ID \
  --query 'Instances[0].InstanceId' --output text)

# 4. Attendre et recuperer l'IP
aws ec2 wait instance-running --instance-ids $INSTANCE_ID
IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID \
  --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)

# 5. Se connecter
ssh -i demo-key.pem ec2-user@$IP

# 6. Nettoyer
aws ec2 terminate-instances --instance-ids $INSTANCE_ID
aws ec2 delete-security-group --group-id $SG_ID
aws ec2 delete-key-pair --key-name demo-key
```

### Exercice 2: S3 Website

```bash
# 1. Creer un bucket
BUCKET="my-website-$(date +%s)"
aws s3 mb s3://$BUCKET

# 2. Configurer pour website
aws s3 website s3://$BUCKET --index-document index.html

# 3. Creer le contenu
echo "<h1>Hello AWS!</h1>" > index.html
aws s3 cp index.html s3://$BUCKET/ --acl public-read

# 4. Bucket policy pour acces public
cat > policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": "*",
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::$BUCKET/*"
  }]
}
EOF
aws s3api put-bucket-policy --bucket $BUCKET --policy file://policy.json

# 5. Acceder au site
echo "http://$BUCKET.s3-website-$(aws configure get region).amazonaws.com"

# 6. Nettoyer
aws s3 rb s3://$BUCKET --force
```

### Exercice 3: IAM

```bash
# 1. Creer un user
aws iam create-user --user-name test-user

# 2. Creer une policy custom
cat > policy.json << 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": ["s3:ListBucket", "s3:GetObject"],
    "Resource": ["arn:aws:s3:::*"]
  }]
}
EOF

POLICY_ARN=$(aws iam create-policy \
  --policy-name S3ReadOnly \
  --policy-document file://policy.json \
  --query 'Policy.Arn' --output text)

# 3. Attacher au user
aws iam attach-user-policy --user-name test-user --policy-arn $POLICY_ARN

# 4. Creer des credentials
aws iam create-access-key --user-name test-user

# 5. Nettoyer
aws iam detach-user-policy --user-name test-user --policy-arn $POLICY_ARN
aws iam delete-policy --policy-arn $POLICY_ARN
aws iam delete-access-key --user-name test-user --access-key-id AKIA...
aws iam delete-user --user-name test-user
```

---

## Cheatsheet

```
┌─────────────────────────────────────────────────────────────┐
│                          AWS                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  CLI SETUP                                                   │
│  ─────────                                                   │
│  aws configure                     # Setup credentials      │
│  aws sts get-caller-identity       # Verify                 │
│                                                              │
│  EC2                                                         │
│  ───                                                         │
│  aws ec2 run-instances ...         # Lancer                 │
│  aws ec2 describe-instances        # Lister                 │
│  aws ec2 stop-instances            # Arreter                │
│  aws ec2 terminate-instances       # Supprimer              │
│                                                              │
│  S3                                                          │
│  ──                                                          │
│  aws s3 mb s3://bucket             # Creer bucket           │
│  aws s3 cp file s3://bucket/       # Upload                 │
│  aws s3 sync ./dir s3://bucket/    # Sync                   │
│  aws s3 ls s3://bucket/            # Lister                 │
│  aws s3 rb s3://bucket --force     # Supprimer              │
│                                                              │
│  IAM                                                         │
│  ───                                                         │
│  aws iam create-user               # Creer user             │
│  aws iam create-role               # Creer role             │
│  aws iam attach-user-policy        # Attacher policy        │
│                                                              │
│  ECR                                                         │
│  ───                                                         │
│  aws ecr get-login-password | docker login ...              │
│  docker push ACCOUNT.dkr.ecr.REGION.amazonaws.com/app       │
│                                                              │
│  SERVICES CLES                                               │
│  ─────────────                                               │
│  EC2: VMs          S3: Stockage      RDS: BDD               │
│  VPC: Reseau       IAM: Acces        ECS: Containers        │
│  Lambda: Serverless                  CloudWatch: Monitoring │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Interview Qs - Questions classiques

1. **C'est quoi la difference entre une region et une AZ?**
   → Region: zone geographique (eu-west-1). AZ: datacenter dans une region (eu-west-1a). Multi-AZ = haute dispo.

2. **Difference entre S3 et EBS?**
   → S3: stockage objet, acces via HTTP, pour fichiers/backups. EBS: block storage, attache a EC2, pour OS/databases.

3. **C'est quoi IAM?**
   → Identity and Access Management. Gere les users, roles, permissions. Principe du moindre privilege.

4. **Difference entre Security Group et NACL?**
   → SG: niveau instance, stateful. NACL: niveau subnet, stateless. SG est le plus utilise.

5. **C'est quoi un VPC?**
   → Virtual Private Cloud. Ton reseau prive dans AWS. Subnets, routing, isolation.

6. **Comment securiser une infra AWS?**
   → IAM least privilege, SG restrictifs, VPC prive, encryption (KMS), CloudTrail pour audit.

---

## Sujets lies

- **Avant:** [Cloud Basics](/devops/cloud-basics) - Fondamentaux du cloud
- **Avant:** [Docker](/devops/docker) - Containers sur AWS
- **Apres:** [Kubernetes](/devops/kubernetes) - EKS sur AWS
- **Apres:** [Terraform](/devops/terraform) - Infrastructure as Code pour AWS

---

*Temps estime: 55 min lecture + 35 min pratique*
